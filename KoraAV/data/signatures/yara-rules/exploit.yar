/*
   YARA Rules - Exploit Detection
   Compatible with: YARA v4.x
   Author: KoraAV Project Default
   Description: Detects common exploits and malicious scripts
   Last Updated: 2025-02-23
*/

rule PowerShell_Obfuscation {
    meta:
        description = "Detects obfuscated PowerShell scripts"
        severity = "high"
        confidence = "medium"
        category = "exploit"
        
    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        
        $obf1 = "-enc" nocase
        $obf2 = "-encodedcommand" nocase
        $obf3 = "frombase64string" nocase
        $obf4 = "invoke-expression" nocase
        $obf5 = "iex(" nocase
        $obf6 = "[char]" nocase
        
        $bypass1 = "-executionpolicy bypass" nocase
        $bypass2 = "-ep bypass" nocase
        $bypass3 = "-nop" nocase
        $bypass4 = "-noprofile" nocase
        
    condition:
        (1 of ($ps*) and 2 of ($obf*)) or
        (1 of ($ps*) and 1 of ($bypass*) and 1 of ($obf*))
}

rule Malicious_Macro {
    meta:
        description = "Detects malicious Office macros"
        severity = "high"
        confidence = "medium"
        category = "exploit"
        
    strings:
        $auto1 = "AutoOpen" nocase
        $auto2 = "AutoExec" nocase
        $auto3 = "Document_Open" nocase
        $auto4 = "Workbook_Open" nocase
        
        $exec1 = "WScript.Shell" nocase
        $exec2 = "Shell" nocase
        $exec3 = "CreateObject" nocase
        $exec4 = "powershell" nocase
        $exec5 = "cmd.exe" nocase
        
        $download1 = "URLDownloadToFile" nocase
        $download2 = "XMLHTTP" nocase
        $download3 = "DownloadFile" nocase
        
    condition:
        (1 of ($auto*) and 1 of ($exec*)) or
        (1 of ($auto*) and 1 of ($download*))
}

rule PHP_Webshell_Generic {
    meta:
        description = "Generic PHP webshell detection"
        severity = "high"
        confidence = "medium"
        category = "exploit"
        
    strings:
        $php = "<?php"
        
        $exec1 = "system(" nocase
        $exec2 = "shell_exec(" nocase
        $exec3 = "passthru(" nocase
        $exec4 = "exec(" nocase
        
        $obf1 = "base64_decode(" nocase
        $obf2 = "str_rot13(" nocase
        $obf3 = "gzinflate(" nocase
        $obf4 = "eval(" nocase
        
        $post1 = "$_POST" nocase
        $post2 = "$_GET" nocase
        $post3 = "$_REQUEST" nocase
        
    condition:
        $php and (2 of ($exec*) or (1 of ($obf*) and 1 of ($post*)))
}

rule SQL_Injection_Attempt {
    meta:
        description = "Detects SQL injection patterns"
        severity = "high"
        confidence = "low"
        category = "exploit"
        
    strings:
        $sql1 = "' OR '1'='1" nocase
        $sql2 = "' OR 1=1--" nocase
        $sql3 = "UNION SELECT" nocase
        $sql4 = "; DROP TABLE" nocase
        $sql5 = "'; EXEC" nocase
        $sql6 = "admin'--" nocase
        
    condition:
        1 of them
}

rule LNK_File_Exploit {
    meta:
        description = "Detects suspicious LNK files"
        severity = "high"
        confidence = "medium"
        category = "exploit"
        
    strings:
        $lnk_header = { 4C 00 00 00 01 14 02 00 }
        
        $ps1 = "powershell" nocase
        $cmd1 = "cmd.exe /c" nocase
        $download1 = "iwr " nocase
        $download2 = "wget " nocase
        $download3 = "curl " nocase
        
    condition:
        $lnk_header at 0 and (1 of ($ps*) or 1 of ($cmd*) or 1 of ($download*))
}

rule Mimikatz {
    meta:
        description = "Detects Mimikatz credential dumper"
        severity = "critical"
        confidence = "high"
        category = "exploit"
        family = "Mimikatz"
        
    strings:
        $str1 = "mimikatz" nocase
        $str2 = "sekurlsa" nocase
        $str3 = "kerberos" nocase
        $str4 = "lsadump" nocase
        $str5 = "privilege::debug" nocase
        $str6 = "gentilkiwi" nocase
        
    condition:
        2 of them
}

rule EternalBlue_Exploit {
    meta:
        description = "Detects EternalBlue exploit (MS17-010)"
        severity = "critical"
        confidence = "high"
        category = "exploit"
        reference = "CVE-2017-0144"
        
    strings:
        $str1 = "PC NETWORK PROGRAM 1.0" nocase
        $str2 = "LANMAN1.0" nocase
        $str3 = "Windows for Workgroups 3.1a" nocase
        $str4 = "\\x00\\x00\\x00\\x31\\x00" 
        
        $doublepulsar = "DllPath" nocase
        
    condition:
        3 of ($str*) or $doublepulsar
}

rule BloodHound_AD_Tool {
    meta:
        description = "Detects BloodHound AD enumeration tool"
        severity = "high"
        confidence = "high"
        category = "exploit"
        family = "BloodHound"
        
    strings:
        $str1 = "BloodHound" nocase
        $str2 = "SharpHound" nocase
        $str3 = "Invoke-BloodHound" nocase
        $str4 = "bloodhound-python" nocase
        
    condition:
        1 of them
}

