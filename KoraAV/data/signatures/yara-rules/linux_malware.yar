/*
   KoraAV YARA Rules - Linux Malware Detection
   These rules detect common Linux malware patterns
*/

rule Linux_Mirai_Botnet
{
    meta:
        description = "Detects Mirai botnet variants"
        author = "KoraAV Default"
        severity = "high"
        
    strings:
        $s1 = "/bin/busybox" ascii
        $s2 = "PING" ascii
        $s3 = "DDoS" nocase
        $s4 = "attack" nocase
        $s5 = "botnet" nocase
        
    condition:
        3 of ($s*)
}

rule Linux_Reverse_Shell
{
    meta:
        description = "Detects reverse shell patterns"
        author = "KoraAV Default"
        severity = "critical"
        
    strings:
        $bash1 = "/bin/bash -i" ascii
        $bash2 = "/bin/sh -i" ascii
        $dev_tcp = "/dev/tcp/" ascii
        $nc1 = "nc -e /bin/bash" ascii
        $nc2 = "nc -e /bin/sh" ascii
        $python = "socket.socket" ascii
        
    condition:
        any of them
}

rule Linux_Cryptocurrency_Miner
{
    meta:
        description = "Detects cryptocurrency miners"
        author = "KoraAV Default"
        severity = "medium"
        
    strings:
        $xmrig = "xmrig" nocase
        $monero = "monero" nocase
        $stratum = "stratum+tcp" ascii
        $mining_pool1 = "pool.minexmr" ascii
        $mining_pool2 = "pool.supportxmr" ascii
        $donate_level = "donate-level" ascii
        $cpu_usage = "max-cpu-usage" ascii
        
    condition:
        2 of them
}

rule Linux_Rootkit_Indicators
{
    meta:
        description = "Detects rootkit characteristics"
        author = "KoraAV Default"
        severity = "critical"
        
    strings:
        $hide1 = "hide_proc" ascii
        $hide2 = "hide_file" ascii
        $lkm1 = "init_module" ascii
        $lkm2 = "cleanup_module" ascii
        $hook = "sys_call_table" ascii
        $preload = "LD_PRELOAD" ascii
        
    condition:
        2 of them
}

rule Linux_Ransomware
{
    meta:
        description = "Detects Linux ransomware"
        author = "KoraAV Default"
        severity = "critical"
        
    strings:
        $encrypt1 = "encrypt" nocase
        $encrypt2 = "AES" ascii
        $ransom1 = "ransom" nocase
        $ransom2 = "bitcoin" nocase
        $ransom3 = "payment" nocase
        $readme = "README" ascii
        $extension = ".encrypted" ascii
        
    condition:
        ($encrypt1 or $encrypt2) and 2 of ($ransom*, $readme, $extension)
}

rule Suspicious_Downloader
{
    meta:
        description = "Detects download-and-execute patterns"
        author = "KoraAV Default"
        severity = "high"
        
    strings:
        $wget1 = "wget -q" ascii
        $wget2 = "wget -O" ascii
        $curl1 = "curl -s" ascii
        $curl2 = "curl -o" ascii
        $pipe_bash = "| bash" ascii
        $pipe_sh = "| sh" ascii
        $chmod = "chmod +x" ascii
        
    condition:
        (($wget1 or $wget2 or $curl1 or $curl2) and ($pipe_bash or $pipe_sh)) or
        (($wget1 or $wget2 or $curl1 or $curl2) and $chmod)
}

rule Linux_Backdoor
{
    meta:
        description = "Detects backdoor characteristics"
        author = "KoraAV Default"
        severity = "critical"
        
    strings:
        $bind_shell = "bind_shell" ascii
        $reverse_conn = "reverse_connection" ascii
        $listen = "listen(" ascii
        $accept = "accept(" ascii
        $fork_exec = "fork(" ascii wide
        $dup2 = "dup2(" ascii
        $passwd = "/etc/passwd" ascii
        $shadow = "/etc/shadow" ascii
        
    condition:
        3 of them
}

rule Suspicious_Base64_Usage
{
    meta:
        description = "Detects suspicious base64 usage (obfuscation)"
        author = "KoraAV Default"
        severity = "medium"
        
    strings:
        $base64_bash = "base64 -d" ascii
        $base64_python = "base64.b64decode" ascii
        $eval = "eval" ascii
        $exec = "exec(" ascii
        
        // Common base64 encoded shell commands
        $encoded1 = "L2Jpbi9iYXNo" ascii  // /bin/bash
        $encoded2 = "L2Jpbi9zaA==" ascii  // /bin/sh
        $encoded3 = "Y3VybCA" ascii       // curl
        
    condition:
        ($base64_bash or $base64_python) and ($eval or $exec) or
        any of ($encoded*)
}

rule Linux_Info_Stealer
{
    meta:
        description = "Detects information stealing behavior"
        author = "KoraAV Default"
        severity = "high"
        
    strings:
        $ssh_keys = ".ssh/id_rsa" ascii
        $browser1 = ".mozilla/firefox" ascii
        $browser2 = ".config/google-chrome" ascii
        $browser3 = ".config/chromium" ascii
        $wallet1 = ".electrum" ascii
        $wallet2 = ".bitcoin" ascii
        $aws = ".aws/credentials" ascii
        $gcloud = ".config/gcloud" ascii
        $passwd = "/etc/passwd" ascii
        $shadow = "/etc/shadow" ascii
        
    condition:
        3 of them
}

rule Suspicious_Cron_Persistence
{
    meta:
        description = "Detects cron-based persistence"
        author = "KoraAV Default"
        severity = "medium"
        
    strings:
        $cron1 = "/etc/crontab" ascii
        $cron2 = "/var/spool/cron" ascii
        $cron3 = "crontab -e" ascii
        $wget = "wget" ascii
        $curl = "curl" ascii
        $download = "download" nocase
        
    condition:
        any of ($cron*) and (any of ($wget, $curl, $download))
}
